context("zipper")
library(ggplot2)

test_that("zipper checks arguments properly", {
  data("MIsim", package = "rsimsum")
  data("frailty", package = "rsimsum")
  s <- simsum(data = MIsim, estvarname = "b", true = 0.5, se = "se", methodvar = "method", x = TRUE)
  sm <- multisimsum(data = frailty, par = "par", true = c(trt = -0.50, fv = 0.75), estvarname = "b", se = "se", methodvar = "model", x = TRUE)
  expect_error(zipper(obj = MIsim))
  expect_error(zipper(obj = s, wald.level = 101))
  expect_error(zipper(obj = s, gpars = list(wrong.parameter = 1)))
  expect_error(zipper(obj = sm, wald.level = 101))
  expect_error(zipper(obj = sm, par = "hello"))
  expect_error(zipper(obj = sm, gpars = list(wrong.parameter = 1)))
})

test_that("zipper fails when simsum/multisimsum are called with x = FALSE", {
  data("MIsim", package = "rsimsum")
  s <- simsum(data = MIsim, estvarname = "b", true = 0.5, se = "se", methodvar = "method")
  data("frailty", package = "rsimsum")
  sm <- multisimsum(data = frailty, par = "par", true = c(trt = -0.50, fv = 0.75), estvarname = "b", se = "se", methodvar = "model")
  expect_error(zipper(s))
  expect_error(zipper(sm, par = "trt"))
})

test_that("zipper returns a ggplot object", {
  data("MIsim", package = "rsimsum")
  data("frailty", package = "rsimsum")
  s <- simsum(data = MIsim, estvarname = "b", true = 0.5, se = "se", methodvar = "method", x = TRUE)
  sm <- multisimsum(data = frailty, par = "par", true = c(trt = -0.50, fv = 0.75), estvarname = "b", se = "se", methodvar = "model", x = TRUE)
  expect_s3_class(zipper(s), class = c("gg", "ggplot"))
  expect_s3_class(zipper(sm, par = "trt"), class = c("gg", "ggplot"))
})

test_that("zipper works when changing graphical parameters", {
  data("MIsim", package = "rsimsum")
  s <- simsum(data = MIsim, estvarname = "b", true = 0.5, se = "se", methodvar = "method", x = TRUE)
  zipper(s, gpars = list(ci.alpha = 1))
  zipper(s, gpars = list(true.colour = 2))
  zipper(s, gpars = list(true.shape = 3))
  zipper(s, gpars = list(ci.colour = 4))
  zipper(s, gpars = list(ci.shape = 5))
  data("frailty", package = "rsimsum")
  sm <- multisimsum(data = frailty, par = "par", true = c(trt = -0.50, fv = 0.75), estvarname = "b", se = "se", methodvar = "model", x = TRUE)
  zipper(sm, par = "trt", gpars = list(ci.alpha = 1))
  zipper(sm, par = "trt", gpars = list(true.colour = 2))
  zipper(sm, par = "trt", gpars = list(true.shape = 3))
  zipper(sm, par = "trt", gpars = list(ci.colour = 4))
  zipper(sm, par = "trt", gpars = list(ci.shape = 5))
})

test_that("zipper works with all possible combinations of `methodvar`, `by`", {
  data("relhaz", package = "rsimsum")
  zipper(simsum(data = relhaz, estvarname = "theta", true = -0.5, se = "se", methodvar = "model", by = c("n", "baseline"), x = TRUE))
  zipper(simsum(data = relhaz, estvarname = "theta", true = -0.5, se = "se", by = c("n", "baseline"), x = TRUE))
  zipper(simsum(data = relhaz, estvarname = "theta", true = -0.5, se = "se", methodvar = "model", x = TRUE))
  zipper(simsum(data = relhaz, estvarname = "theta", true = -0.5, se = "se", x = TRUE))
  data("frailty", package = "rsimsum")
  zipper(multisimsum(data = frailty, par = "par", true = c(trt = -0.50, fv = 0.75), estvarname = "b", se = "se", methodvar = "model", by = "fv_dist", x = TRUE), par = "trt")
  zipper(multisimsum(data = frailty, par = "par", true = c(trt = -0.50, fv = 0.75), estvarname = "b", se = "se", by = "fv_dist", x = TRUE), par = "trt")
  zipper(multisimsum(data = frailty, par = "par", true = c(trt = -0.50, fv = 0.75), estvarname = "b", se = "se", methodvar = "model", x = TRUE), par = "trt")
  zipper(multisimsum(data = frailty, par = "par", true = c(trt = -0.50, fv = 0.75), estvarname = "b", se = "se", x = TRUE), par = "trt")
})
